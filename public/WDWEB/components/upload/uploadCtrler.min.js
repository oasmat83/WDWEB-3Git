angular.module("WDWeb").controller("uploadCtrler",["$scope","$rootScope","$route","$routeParams","$timeout","$log","$window","$localStorage","$location","uploader","wdService","homeService","fileListUI",function(d,r,e,t,l,a,o,n,s,f,u,c,p){var v=this;function h(r,n,e){e.reduce(function(e,i,d){return e.then(function(){return t=r,l=n,a=i,o=d,new Promise(function(e,i){setTimeout(function(){t.Description=a.name.split(".").slice(0,-1).join(".")||filename+"",F(t,l,a,o),e({value:a})},1500)});var t,l,a,o})},Promise.resolve()).then(function(){setTimeout(function(){d.uploadData.disabled=!0,d.checkDesc.validationRules[0].type="required",d.uploadData.Description="",d.$apply()},4e3)})}function F(l,e,i,t){v.uploadInc=!1,u.uploadDoc(l,e,i).then(function(e){var i=e.data.download;if(""!=i.errorStatus.ErrorCount){v.uploadInc=!0;for(var t=1;t<=7;t++)""!==i["wd_File_Field_Error"+t]?v["wdFieldColor"+t]="#a80000":v["wdFieldColor"+t]="#107c10",v.fieldDesc["field"+t]=i["FileField"+t+"Desc"];return!1}d.uploadVerb(e.data.download,l)},function(e){v.uploadInc=!0,a.error(err)})}function g(e,i){d.checkDesc.validationRules[0].type=e,(d.uploadData.disabled=i)&&(d.uploadData.Description="")}function b(e){e.validationGroup.validate().isValid&&v.sendTo()}v.checkFt=!1,v.moreTables=!1,d.cabinetList=[],v.uploadInc=!0,d.accept="*",d.value=[],d.fieldTableSpin=!0,v.showPgFields={field1:"",field2:"",field3:"",field4:"",field5:"",field6:"",field7:""},v.securityList=[{name:"None",value:""},{name:"Hidden",value:16},{name:"Protected",value:8}],d.listOfTags=[],d.tagValues=[],v.fieldListData=[],d.openCats=!1,d.showUploadLoader=!0,d.textValue="",angular.element(o).bind("resize",function(){void 0!==$("#leftUploader").dxScrollView("instance")&&$("#leftUploader").dxScrollView("instance").option("height",window.innerHeight-225)}),d.wdFilterBox={placeholder:"Filter",elementAttr:{id:"wdFilterUpload"},onEnterKey:function(e){d.fieldTableSpin=!1,d.textValue=e.event.target.value,"ft"==v.prefillData?v.searchFt():l(function(){d.fieldTableSpin=!0},1e3)},showClearButton:!0},d.wdFilterSideBtn={icon:"ms-Icon ms-Icon--Accept",onClick:function(e){d.fieldTableSpin=!1;var i=$("#wdFilterUpload").dxTextBox("instance");d.textValue=i.option("value"),"ft"==v.prefillData?v.searchFt():l(function(){d.fieldTableSpin=!0},1e3)},elementAttr:{class:"wdFilterSideBtn"}},d.uploadMode="instantly",d.$on("setFavQuick",function(e){d.showUploadLoader=!0,v.quickProfile=[],v.favMatters=[],v.prefillData="",v.uploadTitle="QuickProfile",l(function(){u.getQuickProfile().then(function(e){v.quickProfile=e.data.root.QuickProfiles,v.prefillData="qp",d.showUploadLoader=!1,v.selected=e.data.root.QuickProfiles[0],d.setOverUpload()},function(e){d.qpError="No quickprofiles found!",a.error(e)}),u.getFavMatters().then(function(e){v.favMatters=e.data.root.FavMatters,d.showUploadLoader=!1,d.setOverUpload()},function(e){a.log(e)})},1e3),u.getCabinetList().then(function(e){if(d.cabinetList=[],""!=e.data.root.Header.ErrorCount)return DevExpress.ui.notify(e.data.root.Header.wd_Error_MSG+"!","error",4e3),!1;for(i=0;i<e.data.root.Cabinets.length;i++)d.cabinetList.push(e.data.root.Cabinets[i]);d.setOverUpload()},function(e){console.log(e)}),d.setCategoryList("")}),d.setOverUpload=function(){$("#pxpUploadForm").mouseover(function(e){r.checkOverUpload=!0}),$("#pxpUploadForm").mouseout(function(e){r.checkOverUpload=!1})},v.init=function(){d.uploadData={Cabinets:"",Description:"",Security:"",Type:"3",disabled:!1},v.fieldDesc={field1:"",field2:"",field3:"",field4:"",field5:"",field6:"",field7:""},v.isActive=function(e){return v.selected===e},v.selectedCabinet=function(e){for(var i=e.value.split("|"),t=1;t<=7;t++)""!=i[t]?v.showPgFields["field"+t]=i[t]:v.showPgFields["field"+t]="";if(void 0!==e.event&&(d.fields={field1:{value:""},field2:{value:""},field3:{value:""},field4:{value:""},field5:{value:""},field6:{value:""},field7:{value:""}},v.fieldDesc={field1:"",field2:"",field3:"",field4:"",field5:"",field6:"",field7:""}),"ft"==v.prefillData){var l=e.value.split("|");for(t=1;t<=7;t++)if(""!==l[t]){v.getTables(t,l[t]);break}}},v.fileFlag=!1,l(function(){angular.element(document).ready(function(){for(var e=document.querySelectorAll(".fieldSpinner"),i=0;i<e.length;i++)new fabric.Spinner(e[i])})},0),v.homeService=c,d.$watch("homeService.getMatterList()",function(e){v.favMatters=e}),d.fields={field1:{value:"",placeholder:"Field1",onValueChanged:function(e){d.fields.field1.value=e.value}},field2:{value:"",placeholder:"Field2",onValueChanged:function(e){d.fields.field2.value=e.value}},field3:{value:"",placeholder:"Field3",onValueChanged:function(e){d.fields.field3.value=e.value}},field4:{value:"",placeholder:"Field4",onValueChanged:function(e){d.fields.field4.value=e.value}},field5:{value:"",placeholder:"Field5",onValueChanged:function(e){d.fields.field5.value=e.value}},field6:{value:"",placeholder:"Field6",onValueChanged:function(e){d.fields.field6.value=e.value}},field7:{value:"",placeholder:"Field7",onValueChanged:function(e){d.fields.field7.value=e.value}}},d.sendBtn={text:"Upload",type:"success",onClick:b,useSubmitBehavior:!1},d.submitUpload={text:"",type:"",useSubmitBehavior:!0,visible:!1},d.securityOpt={bindingOptions:{formData:"uploadData",readOnly:!1,showColonAfterLabel:!0,showValidationSummary:!1,colCount:1},items:f.securitySelect()}},v.setFavMatter=function(e){for(var i=angular.copy(e),t=[],l=1;l<=7;l++)if(e.hasOwnProperty("f"+l+"d")&&""!==e["f"+l+"d"]){var a="<span class='favAlign'><b>"+i["f"+l+"n"]+"</b> "+i["f"+l+"c"]+" "+i["f"+l+"d"]+"</span>";t.push(a)}return t.unshift("<h3>&nbsp;&nbsp;"+i.szPGID.toUpperCase()+"</h3>"),t.join("&nbsp;&nbsp;")},v.setFieldTableOrder=function(e){for(var i=[],t=1;t<=7;t++)if(e.hasOwnProperty("f"+t+"n")){var l=e["f"+t+"n"]+" ("+e["f"+t+"d"]+")";i.push(l)}return i.reverse().join(" - ")},v.closeList=function(){u.clearListfromParm(n.ftListId).then(function(e){},function(e){DevExpress.ui.notify("Fatal IIS Error!","error",4e3)})},d.checkTables=function(){var e=v.selectedField;v.getTables(e,d.fields["field"+e].placeholder)},v.getTables=function(e,i){$("#wdFilterUpload").dxTextBox("instance").option("value",""),v.total="",v.ftCount="",d.fieldTableSpin=!1,v.selectedField=e,v.maxcount=500,v.indexFr=0,v.prefillData="",v.uploadTitle=i,d.fieldPanel=!0,v.autoFilter="",n.ftListId&&v.closeList(),l(function(){v.checkFt=!0,v.prefillData="ft",v.fieldListData=[],d.listTable(!1,!1)},1e3)},v.loadMore={text:"Load More",type:"success",useSubmitBehavior:!1,onClick:function(){v.indexFr=+v.indexFr+(v.maxcount+1),d.listTable(!0,!1)}},v.searchFt=function(){d.fieldTableSpin=!1,l(function(){v.fieldListData=[],d.listTable(!1,!0)},1e3)},d.listTable=function(t,e){u.fieldTables(d.uploadData.Cabinets.split("|")[0],d.fields,v.selectedField,v.maxcount,v.indexFr,e,d.textValue).then(function(e){if(v.total=e.data.root.Header.ListCount,v.listlength=e.data.root.FieldTbl.length,""!=e.data.root.Header.ErrorCount)return DevExpress.ui.notify(e.data.root.Header.wd_Error_MSG+"!","error",4e3),!1;if(n.ftListId=e.data.root.Header.List_ID,t){var i=v.fieldListData.concat(e.data.root.FieldTbl);v.listlength=i.length,v.fieldListData=i}else v.fieldListData=e.data.root.FieldTbl;v.total>v.maxcount?(v.moreTables=!0,v.checkFt=!0,v.ftCount=" "+v.listlength+" of "+v.total):("1"==v.total?v.ftCount=" 1 of 1":v.ftCount=" "+v.total+" of "+v.total,v.checkFt=!1),d.fieldNum=e.data.root.Header.FieldNum,v.listCount=parseInt(e.data.root.Header.ListCount),d.fieldNumber=v.selectedField,l(function(){d.fieldTableSpin=!0},1e3)},function(e){d.fieldTableSpin=!0,DevExpress.ui.notify("Server Error!","error",4e3)})},v.tags={bindingOptions:{dataSource:"listOfTags",value:"tagValues"},displayExpr:"CD",valueExpr:"CD",itemTemplate:"customTagItem"},d.getTestProfile=function(){u.testProfile(d.uploadData,d.fields).then(function(e){var i=e.data;if(""!=i.Header.ErrorCount)return d.showDetails(i),!1;d.listOfTags=[],d.setCategoryList(i.Profile.wdPath),d.showDetails(i)},function(e){DevExpress.ui.notify("IIS Fatal Error!","error",4e3)})},d.showDetails=function(e){var i=e.Profile.Fields;d.upload.fieldDesc={field1:i.Field1.wd_File_Field_Error,field2:i.Field2.wd_File_Field_Error,field3:i.Field3.wd_File_Field_Error,field4:i.Field4.wd_File_Field_Error,field5:i.Field5.wd_File_Field_Error,field6:i.Field6.wd_File_Field_Error,field7:i.Field7.wd_File_Field_Error};for(var t=1;t<=7;t++)""!==i["Field"+t].wd_File_Field_Error?v["wdFieldColor"+t]="#a80000":v["wdFieldColor"+t]="#107c10",v.fieldDesc["field"+t]=i["Field"+t].wd_File_Field_Desc},d.setCategoryList=function(e){var i=decodeURIComponent(e);p.getCategoryList(i).then(function(e){var i=e.data.root;if(""!==i.Header.Error_Count)return DevExpress.ui.notify(i.Header.Error_Msg,"error",4e3),!1;d.listOfTags=i.Items},function(e){DevExpress.ui.notify("IIS Error","error",4e3)})},v.getUploadData=function(e,i){if($(window).width()<=767&&($("#phxUpload .nav-save").css({display:"none",width:"0%"}),$("#phxUpload .saveForm").css({display:"block",width:"100%"})),v.fileFlag=!0,v.selected=e,v.autoFilter="",i){for(var t=1;t<=7;t++)if(0==e.hasOwnProperty("f"+[t]+"n")){e["f"+[t]+"n"]=""}for(t=1;t<=7;t++)if(0==e.hasOwnProperty("f"+[t]+"c")){e["f"+[t]+"c"]=""}}for(t=1;t<=7;t++)d.fields["field"+t].value=e["f"+t+"c"];d.uploadData.Cabinets=e.dwPGID+"|"+e.f1n+"|"+e.f2n+"|"+e.f3n+"|"+e.f4n+"|"+e.f5n+"|"+e.f6n+"|"+e.f7n+"|",d.uploadDatadisabled=d.uploadData.disabled,v.fieldDesc={field1:e.f1d,field2:e.f2d,field3:e.f3d,field4:e.f4d,field5:e.f5d,field6:e.f6d,field7:e.f7d}},v.sendTo=function(){1<d.value.length?h(d.uploadData,d.fields,d.value):F(d.uploadData,d.fields,d.value[0])},d.uploadVerb=function(e,i){u.uploadVerb(e,d.value,i).then(function(e){var i=e.data.uploadVerb;if(""!=i.errorStatus.ErrorCount){v.uploadInc=!0;var t={wdMsg:i.errorStatus.wd_Error_MSG};return d.$parent.dialogTitle="Upload",d.$parent.fileErrorMessage.push(t),d.$parent.genericError=!0,d.$parent.errorTypeDialog="action",!(d.$parent.fileError=!0)}l(function(){v.uploadInc=!0;for(var e=1;e<=7;e++)null==d.fields["field"+[e]].value&&(d.fields["field"+[e]].value="");s.path("/home").search({xName:"",fName:"",access:"",create:"",modified:"",text:"",field1:d.fields.field1.value,field2:d.fields.field2.value,field3:d.fields.field3.value,field4:d.fields.field4.value,field5:d.fields.field5.value,field6:d.fields.field6.value,field7:d.fields.field7.value,cabinet:d.uploadData.Cabinets.split("|")[0],typeid:"template",temp:"",id:Date.now()})},2e3)},function(e){a.error(e)})},d.uploadDocument=function(){"2"==d.saveType?o.location.href=n.host+"/cgi-bin/wdwebcgi.exe?SERVE+wd_SID="+n.userData.session+"+html=/fileFunctions/apiList.json+cabinet="+d.uploadData.Cabinets.split("|")[0]+"+f1="+d.fields.field1.value+"+f2="+d.fields.field2.value+"+f3="+d.fields.field3.value+"+f4="+d.fields.field4.value+"+f5="+d.fields.field5.value+"+f6="+d.fields.field6.value+"+f7="+d.fields.field7.value+"+desc="+d.uploadData.Description+"+type=3+security="+d.uploadData.Security:u.getFolderLevel().then(function(e){for(var i=0;i<e.data.root.Cabinets.length;i++)if(e.data.root.Cabinets[i].pgID==d.uploadData.Cabinets.split("|")[0]&&void 0!==d.uploadData.Type){var t=e.data.root.Cabinets[i].pgFields.split("|");return o.location.href=n.host+"/cgi-bin/wdwebcgi.exe?SERVE+wd_SID="+n.userData.session+"+html=/fileFunctions/apiList.json+cabinet="+d.uploadData.Cabinets.split("|")[0]+"+f1="+t[1]+"+f2="+t[2]+"+f3="+t[3]+"+f4="+t[4]+"+f5="+t[5]+"+f6="+t[6]+"+f7="+t[7]+"+desc="+d.uploadData.Description+"+type="+d.uploadData.Type+"+security="+d.uploadData.Security,!1}},function(e){a.error(e)})},d.getFieldsDesc=function(e){var i=e.element[0].id.split("fieldDesc")[1],t={field1:d.fields.field1.value,field2:d.fields.field2.value,field3:d.fields.field3.value,field4:d.fields.field4.value,field5:d.fields.field5.value,field6:d.fields.field6.value,field7:d.fields.field7.value};u.getFieldDes(d.uploadData.Cabinets.split("|")[0],t,i,"SAVE").then(function(e){var i=e.data.data.fields;v.fieldDesc={field1:i.field1,field2:i.field2,field3:i.field3,field4:i.field4,field5:i.field5,field6:i.field6,field7:i.field7}},function(e){DevExpress.ui.notify("Fatal IIS Error!","error",4e3)})},v.wdButtons=function(e,i){$("#wdFilterUpload").dxTextBox("instance").option("value",""),$(window).width()<=767&&($("#phxUpload .nav-save").css({display:"block",width:"100%","border-right":"0px"}),$("#phxUpload .saveForm").css({display:"none",width:"0%"})),v.prefillData=e,v.uploadTitle=i,v.selectedField=0,v.autoFilter="",v.checkFt=!1,v.selected="QuickProfile"==i?v.quickProfile[0]:v.favMatters[0]},v.scrollLeftNav={scrollByContent:!0,scrollByThumb:!0,showScrollbar:"always",height:function(){return window.innerHeight-225},useNative:!0},v.scrollRightForm={scrollByContent:!0,scrollByThumb:!0,showScrollbar:"always",height:function(){return window.innerHeight-250},useNative:!0},d.newFileBtn={uploadUrl:n.host+n.uploadLocation,multiple:!1,uploadedMessage:"I am ready.",selectButtonText:"Click to Browse or Drop file here",bindingOptions:{accept:"accept",value:"value",uploadMode:"uploadMode"},onValueChanged:function(e){d.value=e.value,1===e.value.length&&g("required",!1)},onOptionChanged:function(e){100===e.value&&(1<e.model.value.length?g("",!0):g("required",!1))}},v.setSelected=function(e){v.selected=e},v.getCategoryList=function(e){var i=p.getCategoryList(e),o=[];i.then(function(e){var i=e.data;if(d.wholeCatList=i.root,""!=i.root.Header.Error_Count)return DevExpress.ui.notify(i.Header.wd_Error_MSG+"!","error",4e3),!1;angular.forEach(i.root.Items,function(i,e){i.text=i.CD,i.onClick=function(e){$("#wdTagsList").dxTagBox("option","value").push(i.CD)}});var t=i.root.Items.filter(function(e){return"Personal"==e.TAB_NAME}),l=i.root.Items.filter(function(e){return"Public"==e.TAB_NAME}),a=i.root.Items.filter(function(e){return"Folder"==e.TAB_NAME});0!==t.length&&o.push({text:"Personal",items:t}),0!==l.length&&o.push({text:"Public",items:l}),0!==a.length&&o.push({text:"Folder",items:a}),d.categoryUpload=[{text:"Select a Category",value:0,items:o},{text:"Add/Edit Tags",value:1,onClick:function(e){e.model.$parent.$parent.$parent.uploadToggle=!1,e.model.$parent.$parent.$parent.openCats=!0,r.$broadcast("categoryList",{cats:d.wholeCatList,file:!1,type:"upLoadTo"})}}]},function(e){DevExpress.ui.notify("IIS Fatal Error!","error",4e3)})},d.categoryUpload=[],v.categoryContextualMenu={target:"#categoryMenuBtn",bindingOptions:{items:"categoryUpload"}},v.contexualMenuBtnCat={width:"100px",text:"Categories",onClick:function(){u.testProfile(d.uploadData,d.fields).then(function(e){var i=e.data;if(""!=i.Header.ErrorCount)return DevExpress.ui.notify(i.Header.wd_Error_MSG+"!","error",4e3),!1;v.getCategoryList(i.Profile.wdPath)},function(e){DevExpress.ui.notify("IIS Fatal Error!","error",4e3)}),$("#wdCatMenu").dxContextMenu("toggle",!0)}},v.uploadToolBar=[{location:"before",text:"Upload"}],v.setField=function(e){for(v.selected=e,i=1;i<=7;i++)e["f"+i+"n"]&&(d.fields["field"+i].value=e["f"+i+"n"],v.fieldDesc["field"+i]=e["f"+i+"d"]);v.autoSearch="",v.autoFilter=""},v.setTooltip=function(e){return"<div class='custom-item'>"+e.pgName+"</div>"},d.enterDesc=function(e){console.log(e)},v.getToolTip=function(e){var t="";for(i=1;i<=7;i++)e["f"+i+"n"]&&(t+=t=e["f"+i+"n"]+" - "+e["f"+i+"d"]+" | ");return t.substring(0,t.length-2)},d.checkDesc={validationRules:[{type:"required",message:"Description is required."}]},d.checkPg={validationRules:[{type:"required",message:"Cabinet is required."}]},d.checkUpload={validationRules:[{type:"required",message:"Upload a file."}]},d.checkField={validationRules:[{type:"required",message:"Field(s) are required"}]}}]).factory("uploader",function(e,i){var t=[{itemType:"group",items:[{dataField:"Security",editorType:"dxSelectBox",editorOptions:{dataSource:[{name:"None",value:""},{name:"Hidden",value:16},{name:"Protected",value:8}],valueExpr:"value",displayExpr:"name"}}]}],l=[{itemType:"group",items:[{dataField:"Description",editorOptions:{placeholder:"Description"},validationRules:[{type:"required"}]},{dataField:"Cabinets",editorType:"dxSelectBox",editorOptions:{dataSource:cabinetList,valueExpr:"pgFields",displayExpr:"pgName"},validationRules:[{type:"required"}]},{dataField:"Field1",template:"Field1",label:{visible:!1},visible:!1},{dataField:"Field2",template:"Field2",label:{visible:!1},visible:!1},{dataField:"Field3",template:"Field3",label:{visible:!1},visible:!1},{dataField:"Field4",template:"Field4",label:{visible:!1},visible:!1},{dataField:"Field5",template:"Field5",label:{visible:!1},visible:!1},{dataField:"Field6",template:"Field6",label:{visible:!1},visible:!1},{dataField:"Field7",template:"Field7",label:{visible:!1},visible:!1},{dataField:"Security",editorType:"dxSelectBox",editorOptions:{dataSource:[{name:"None",value:""},{name:"Hidden",value:16},{name:"Protected",value:8}],valueExpr:"value",displayExpr:"name"}}]}];return{uploadFields:function(){return l},securitySelect:function(){return t}}});var cabinetList=[],fileInfo={name:""};function updateFields(e,i){for(var t=1;t<=7;t++)""!=i[t]?(e.component.itemOption("Field"+[t],"visible",!0),e.component.itemOption("Field"+[t],"editorOptions",{placeholder:i[t]}),e.component.itemOption("Field"+[t],"label",{text:i[t]})):e.component.itemOption("Field"+[t],"visible",!1)}