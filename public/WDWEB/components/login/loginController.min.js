"use strict";angular.module("WDWeb").controller("loginController",["$scope","$timeout","$localStorage","$location","$log","wdService","uxService","loginService","WORLDOX_HOST","homeService","$window","$rootScope",function(a,i,r,t,s,e,o,l,n,d,c,p){var m,u="",g=document.querySelectorAll(".ms-Spinner"),f=t.search(),w={Username:"",Password:""};p.pageTitle="Login to Worldox Web",a.userValid=!1,a.tooglePassWord=!1,a.setBtnPropterty=!1,a.init=function(){if(p.setBody=!0,a.tooglePassWord)return!(a.passIcon="ms-Icon ms-Icon--Hide");a.passIcon="ms-Icon ms-Icon--RedEye"},function(){switch(t.port()){case"80":case"443":u=t.protocol()+"://"+t.host()+"/";break;default:u=t.protocol()+"://"+t.host()+":"+t.port()+"/"}}(),a.moveToLeft=!0,a.direction=0,a.spinner=!0,a.loginSpinner=!0,a.loginErr="",a.isActive=function(e){return a.selected===e},a.emailValidationRules={validationRules:[{type:"email",message:"Not an email"}],onOptionChanged:function(e){a.userValid=e.value}},a.showPassword={elementAttr:{id:"showPassword"},text:"Show Password",value:!1,tabIndex:4,onOptionChanged:function(e){if(!e.value)return $("#password").dxTextBox("instance").option("mode","password"),!1;$("#password").dxTextBox("instance").option("mode","text")}},a.rememberUserName={elementAttr:{id:"rememberUserName"},text:"Remember Email",value:!1,tabIndex:3,onOptionChanged:function(e){1==e.value?a.isRememberUserName=!0:a.isRememberUserName=!1},onContentReady:function(e){localStorage.rememberUserName?e.component.option("value",!0):e.component.option("value",!1)}},i(function(){$("#user input").val(localStorage.rememberUserName),a.userValid=localStorage.rememberUserName,a.loginData.username.value=localStorage.rememberUserName},100),i(function(){for(var e=0;e<g.length;e++)new fabric.Spinner(g[e]);angular.element(document).ready(function(){$("#user input").focus(),$("#loginForm").focus(),$("#user input").on("keyup",function(e){e.keyCode})})},0),r.userData?e.chksession().then(function(e){""!=e.data.user&&e.data.user?a.urlDirect():(r.$reset(),a.spinner=!1)},function(e){s.error(e)}):a.spinner=!1,a.selectedTab="Login",a.loginFields={formData:w,readOnly:!1,showColonAfterLabel:!0,showValidationSummary:!1,validationGroup:"customerData",labelLocation:"left",onInitialized:function(e){e.component},items:o.getloginData("Login")},a.loginData={username:{bindingOptions:{value:""},editorOptions:{placeholder:"Username"}},password:{bindingOptions:{value:""},editorOptions:{placeholder:"Password"}}},a.passIcon="ms-Icon ms-Icon--RedEye",a.togglePassword={bindingOptions:{icon:"passIcon"},text:"",onClick:function(e){if(a.tooglePassWord=!a.tooglePassWord,a.tooglePassWord)return $("#password").dxTextBox("instance").option("mode","text"),!(a.passIcon="ms-Icon ms-Icon--Hide");$("#password").dxTextBox("instance").option("mode","password"),a.passIcon="ms-Icon ms-Icon--RedEye"}},a.submitOptions={text:"Login",type:"success",useSubmitBehavior:!0,validationGroup:"customerData",width:"100%",tabIndex:4,template:function(e,t){$("<div class='button-indicator'></div><span class='dx-button-text'>"+e.text+"</span>").appendTo(t),m=t.find(".button-indicator").dxLoadIndicator({visible:!1,width:16,height:16}).dxLoadIndicator("instance")},onClick:function(){m.option("visible",!0),a.setBtnPropterty=!0},bindingOptions:{disabled:"setBtnPropterty"}},a.backOptions={text:"Back",type:"normal",useSubmitBehavior:!1,width:"49%",tabIndex:6,onClick:function(){a.direction=0,a.selection="",$("#pssContainer").addClass("setAnimation"),$("#pssContainer").removeClass("addAnimation"),$("#userContainer").addClass("addAnimation"),$("#userContainer").removeClass("setAnimation"),a.loginErr=""}},a.nextOptions={text:"Next",type:"success",useSubmitBehavior:!1,tabIndex:3,width:"100%",onClick:function(e){if(a.userValid)return a.direction=1,a.selection="password",a.loginErr="",$("#pssContainer").addClass("addAnimation"),$("#pssContainer").removeClass("setAnimation"),$("#userContainer").addClass("setAnimation"),$("#userContainer").removeClass("addAnimation"),i(function(){$("#password input").focus()},0),!1;var t=$("#user").dxTextBox("instance");a.loginErr="Please enter an email",t.focus()}},a.checkEmailValue=function(e){console.log(e)},a.login=function(e){if(a.loginData.password.value&&a.loginData.username){if(null==a.loginData.password&&(w={Username:a.loginData.username.value,Password:""},a.direction=1,a.selection="password",i(function(){$("#password input").focus()},0)),w={Username:a.loginData.username.value,Password:a.loginData.password.value},"remainingAttempts"in localStorage){if(localStorage.remainingAttempts<=0){var t=new Date,o=new Date(localStorage.timeLimitAttempts),n=300-Math.round((t.getTime()-o.getTime())/1e3);a.setBtnPropterty=(n<=0?localStorage.remainingAttempts=4:(a.loginErr="No Attempts left. Please try again after "+n+" seconds",a.loginSpinner=!0),m.option("visible",!1),!1)}}else localStorage.remainingAttempts=4,m.option("visible",!1),a.setBtnPropterty=!1;0<localStorage.remainingAttempts&&l.loginPhx(u,w,"LOGON").then(function(e){if(""!=e.data.ErrorCount){switch(e.data.wd_Error_VAR1){case"wd_USER_CODE_VALUE":a.direction=0,a.selection="",a.loginData.password.value="",m.option("visible",!1),a.setBtnPropterty=!1,a.loginErr="Invalid email, "+ +localStorage.remainingAttempts+" attempts left.";break;case"wd_USER_PASSWORD_VALUE":a.loginData.password.value="",i(function(){$("#password input").focus(),m.option("visible",!1),a.setBtnPropterty=!1,a.loginErr=e.data.wd_Error_MSG1+=", "+localStorage.remainingAttempts+" attempts left."},0);break;case"wd_USER_NAME_VALUE":m.option("visible",!1),a.setBtnPropterty=!1,a.loginErr=e.data.wd_Error_MSG1+=", "+localStorage.remainingAttempts+" attempts left.";break;case"wd_SERVER_NAME_VALUE":return a.loginErr=e.data.wd_Error_MSG1,m.option("visible",!1),a.setBtnPropterty=!1,a.loginErr=e.data.wd_Error_MSG1+=", "+localStorage.remainingAttempts+" attempts left.",!1;default:if(-1!=e.data.indexOf("/WDWEB/Offline.htm"))return a.loginSpinner=!0,a.loginErr="Please check your primary server!",m.option("visible",!1),a.setBtnPropterty=!1;m.option("visible",!1),a.setBtnPropterty=!1,a.loginErr=e.data.wd_Error_MSG1}localStorage.remainingAttempts=localStorage.remainingAttempts-1;var t=new Date;return localStorage.timeLimitAttempts=t,!1}localStorage.remainingAttempts=4,e.data.username=w.Username,e.data.email=w.Username,r.userData=e.data,r.host=u,r.uploadLocation=e.data.uploadFolder,r.initals=e.data.ownerInital,r.serverName=e.data.servername,!0===a.isRememberUserName?localStorage.rememberUserName=w.Username:localStorage.rememberUserName="",i(function(){a.urlDirect()},0)},function(e){a.loginErr="Fatal IIS Error",a.loginSpinner=!0,m.option("visible",!1),a.setBtnPropterty=!1,s.error(e)})}},a.urlDirect=function(){f.action?a.actionType():t.path("/landing")},a.actionType=function(){var e=null==f.wdVer?"":f.wdVer;if("save"==f.action&&f.wdId)t.path("/upload").search({query:f.wdId,formats:f.Formats,hook:f.Hook,popupType:f.PopupType,wdVer:e});else if("save"!=f.action||f.wdId)if("WDL"==f.action)c.location.href=r.host+"/cgi-bin/wdwebcgi.exe?SERVE+wd_SID="+r.userData.session+"+html=/api/apiList.json+loc="+r.uploadLocation+"+domain="+r.host+"+popFlag="+f.PopupType;else{if(f.attach)return t.path("/home").search({query:f.wdId,attach:f.attach,noEdit:f.NotForEdit}),!1;t.path("/home").search({query:f.wdId})}else t.path("/upload").search({query:"",formats:f.Formats,hook:f.Hook,popupType:f.PopupType,multi:f.mult,desc:f.Desc,ext:f.Ext,wdVer:e})},a.testEnter=function(e){13==e.event.keyCode&&(m.option("visible",!0),a.setBtnPropterty=!0)}}]);