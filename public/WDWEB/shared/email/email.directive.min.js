"use strict";angular.module("WDWeb").directive("wdxEmail",[function(){return{restrict:"E",replace:!0,templateUrl:"./WDWEB/shared/email/email.html",link:function(e,t,a){},controller:function(o,s,e,t,r,a,i,l,n){var u=[],c="";o.loadPreview=!0,o.wdlName=!1,o.wdSubjectFlag=!0,o.listOfEmails={to:"",cc:"",bcc:""},o.editableEmails=[s.userData.email],o.onCustomItemCreating=function(e){var t=e.text;o.editableEmails.unshift(t),e.customItem=t},angular.element(n).bind("resize",function(){void 0!==$("#emailContainer").dxScrollView("instance")&&$("#emailContainer").dxScrollView("instance").option("height",window.innerHeight-250)}),o.scrollEmail={scrollByContent:!0,scrollByThumb:!0,showScrollbar:"always",height:function(){return window.innerHeight-250},useNative:!0},o.onCustomFocusOut=function(e){var t=e.component.field(),a=jQuery.Event("keydown");a.keyCode=13,a.which=13,t.trigger(a)},o.onValueChanged=function(e){var t=e.value.toString().replace(/,/g,";");"emailTo"==e.element[0].id?o.listOfEmails.to=t:"emailCC"==e.element[0].id?o.listOfEmails.cc=t:o.listOfEmails.bcc=t},o.keyDownSubj=function(e){o.wdSubjectFlag=!1},o.setWdlValue=function(e){if(o.wdlName)return o.emailData.wdlName=e,!1;o.emailData.wdlName=""},o.$watch(function(){return i.getSelectedList()},function(e){if(u=[],1==e.length&&o.wdSubjectFlag)o.emailData.Subject="Emailing: "+e[0].Name,o.setWdlValue(e[0].Description);else if(1<e.length&&o.wdSubjectFlag){var t=new Date,a=Number((new Date).getMonth())+Number(1),i=12<t.getHours()?t.getHours()-12:t.getHours(),n=12<=t.getHours()?"PM":"AM",r=t.getMinutes()<10?"0"+t.getMinutes():t.getMinutes(),l=t.getSeconds()<10?"0"+t.getSeconds():t.getSeconds();o.emailData.Subject="Emailing: "+e.length+" attachments",o.setWdlValue(e.length+" files ["+s.initals+" "+a+"-"+(new Date).getDate()+"-"+(new Date).getFullYear()+" "+i+"."+r+"."+l+" "+n+"]")}o.fileSelection=e,angular.forEach(e,function(e,t){-1==u.indexOf(e.RN)&&u.push(e.RN)}),c=u.toString()}),o.attachOption=[{display:"File",value:"File"},{display:"Worldox Link",value:"Link"}],o.emailData={To:"",CC:"",bc:"",Subject:"",Attach:"File",Body:"",wdlName:""},o.btnTxt="Send",o.emailBtn={bindingOptions:{text:"btnTxt"},type:"success",useSubmitBehavior:!0},o.sendToUser=function(n){a.isFileHasChanged().then(function(e){if(e)l.$broadcast("showMessageWhenFileChanged"),setTimeout(function(){$("#btnConfirmCheckFile").on("click",function(i){var e;i.preventDefault(),$("#popupFileChangedOptions").dxPopup().dxPopup("instance").hide(),o.spinner=!1,o.btnTxt="Sending",o.loadPreview=!1,e="File"===o.emailData.Attach?1:0,null==o.text&&(t="",console.log("message undefined"));var t=o.text,a=(new DOMParser).parseFromString("<!DOCTYPE html><body>"+t,"text/html").documentElement.outerHTML;r.sendEmailService(o.emailData,i,e,c,o.listOfEmails,a).then(function(e){var t=e.data.fileStatus;if(o.$parent.$parent.$parent.$parent.dialogTitle="Email",""!=t.errorStatus.ErrorCount)return o.errorType(t),o.loadPreview=!0,!(o.btnTxt="Send");o.loadPreview=!0,o.btnTxt="Send";var a={title:i.DocId,desc:i.Description,wdMsg:"File emailed successfully",status:"success",action:"Email"};l.$broadcast("setDialogStatus",a)},function(e){o.loadPreview=!0,o.btnTxt="Send",DevExpress.ui.notify("Email FAILED!","error",4e3)})})},200);else{var t;o.spinner=!1,o.btnTxt="Sending",o.loadPreview=!1,t="File"===o.emailData.Attach?1:0,null==o.text&&(a="",console.log("message undefined"));var a=o.text,i=(new DOMParser).parseFromString("<!DOCTYPE html><body>"+a,"text/html").documentElement.outerHTML;r.sendEmailService(o.emailData,n,t,c,o.listOfEmails,i).then(function(e){var t=e.data.fileStatus;if(o.$parent.$parent.$parent.$parent.dialogTitle="Email",""!=t.errorStatus.ErrorCount)return o.errorType(t),o.loadPreview=!0,!(o.btnTxt="Send");o.loadPreview=!0,o.btnTxt="Send";var a={title:n.DocId,desc:n.Description,wdMsg:"File emailed successfully",status:"success",action:"Email"};l.$broadcast("setDialogStatus",a)},function(e){o.loadPreview=!0,o.btnTxt="Send",DevExpress.ui.notify("Email FAILED!","error",4e3)})}})},o.errorType=function(e){var t;if(""!==e.errorStatus.wd_Error_DOCID)return t={title:e.errorStatus.wd_Error_DOCID,desc:e.errorStatus.wd_Error_DOCNAME,wdMsg:e.errorStatus.wd_Error_MSG,status:"failed",type:!1,action:"Email"},l.$broadcast("setDialogStatus",t),!1;t={wdMsg:e.errorStatus.wd_Error_MSG,status:"failed",type:!0,action:"Email"},o.$parent.fileErrorMessage.push(t),o.$parent.fileError=!0,o.$parent.errorTypeDialog="action",l.$broadcast("setDialogStatus",t)},o.checkTo={validationRules:[{type:"required",message:"Email 'TO' is required!"}]},o.wdGetAttach=function(e){if("Link"==e.value){if(o.wdlName=!0,1==o.fileSelection.length)o.emailData.wdlName=o.fileSelection[0].Description;else{var t=new Date,a=Number((new Date).getMonth())+Number(1),i=12<t.getHours()?t.getHours()-12:t.getHours(),n=12<=t.getHours()?"PM":"AM",r=t.getMinutes()<10?"0"+t.getMinutes():t.getMinutes(),l=t.getSeconds()<10?"0"+t.getSeconds():t.getSeconds();o.emailData.wdlName=o.fileSelection.length+" files ["+s.initals+" "+a+"-"+(new Date).getDate()+"-"+(new Date).getFullYear()+" "+i+"."+r+"."+l+" "+n+"]"}return!1}o.emailData.wdlName="",o.wdlName=!1}}}}]);