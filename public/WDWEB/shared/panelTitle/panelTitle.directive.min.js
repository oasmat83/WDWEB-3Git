"use strict";angular.module("WDWeb").directive("fileTitleData",["$localStorage","$window","wdService","homeService","$rootScope","fileListUI",function(a,d,c,e,s,u){return{scope:{doc:"=",name:"=",list:"=",rec:"=",ln:"=",pop:"=",pgid:"=",field1:"=",field2:"=",field3:"=",field4:"=",field5:"=",field6:"=",field7:"=",name1:"=",name2:"=",name3:"=",name4:"=",name5:"=",name6:"=",name7:"=",selectlist:"=",status:"=",owner:"=",desc:"=",comment:"="},templateUrl:"./WDWEB/shared/panelTitle/panelTitle.html",link:function(i,e,o){var n;s.checkinType,n=d.navigator.userAgent,i.dwnloadSpinner=!0,i.softpopFlag=1,i.multiple=!1,i.accept="*",i.value=[],i.uploadMode="instantly";for(var t=document.querySelectorAll(".ms-Spinner"),r=0;r<t.length;r++)new fabric.Spinner(t[r]);function l(n,e,t){t=void 0===t?0:t,i.spinner=e,c.checkout(n).then(function(e){var o;if(""!=e.data.fileStatus.errorStatus.ErrorCount)return o={message:"DocID: "+n.Name+" "+e.data.fileStatus.errorStatus.wd_Error_MSG,type:"error",position:{at:"bottom",my:"center",of:window,offset:{x:0,y:-50-50*t}}},DevExpress.ui.notify(o),!(i.spinner=!0);o={message:"DocID: "+n.Name+" checked out 'SUCCESSFULLY'!",type:"success",position:{at:"bottom",my:"center",of:window,offset:{x:0,y:-50-50*t}}},DevExpress.ui.notify(o),n.I="48",s.wdStatus=Math.round(new Date/1e3),i.dwnload(n),i.spinner=!0},function(e){$log.log(e)})}i.dwnload=function(){i.dwnloadSpinner=!1;var r={RN:i.rec,LID:i.list,LN:i.ln,PGID:i.pgid,Field1:null==i.field1?"":i.field1,Field2:null==i.field2?"":i.field2,Field3:null==i.field3?"":i.field3,Field4:null==i.field4?"":i.field4,Field5:null==i.field5?"":i.field5,Field6:null==i.field6?"":i.field6,Field7:null==i.field7?"":i.field7};console.log(r),c.download(r).then(function(t){var e=t.data.download;if(""!==e.errorStatus.ErrorCount)i.dwnloadSpinner=!0,DevExpress.ui.notify(e.errorStatus.wd_Error_MSG,"error",4e3);else if(e.message)i.dwnloadSpinner=!0,DevExpress.ui.notify(e.message,"error",4e3);else{if(-1!=n.indexOf("Frowser"))c.getFolderLevel().then(function(e){for(var o=0;o<e.data.root.Cabinets.length;o++)if(e.data.root.Cabinets[o].pgID==r.PGID){var n=e.data.root.Cabinets[o].pgFields.split("|");return i.checkedOut(r,t.data,n),!1}},function(e){$log.error(e),DevExpress.ui.notify("IIS error 500","error",4e3)});else{if("pdf"===i.doc.split(".")[1])return i.dwnloadSpinner=!0,d.open(a.host+t.data.download.fileLoc,"_blank"),!1;d.location.href=a.host+t.data.download.fileLoc}i.dwnloadSpinner=!0}},function(e){$log.error(e)}),i.checkedOut=function(o,n,t){c.checkout(o).then(function(e){if(""!=e.data.fileStatus.errorStatus.ErrorCount)return DevExpress.ui.notify(e.data.fileStatus.errorStatus.wd_Error_MSG,"error",4e3),!1;i.getResponse(n,o,t)},function(e){$log.log(e)})},i.getResponse=function(e,o,n){var t=e.download.FileZMS.replace(/\\/g,"\\\\");n.shift();for(var r=0;r<n.length;r++)""!==n[r]?n[r]=o["Field"+(r+1)]:n[r]="";d.location.href=a.host+"/cgi-bin/wdwebcgi.exe?SERVE+wd_SID="+a.userData.session+"+html=/api/apiList.json+dwLoc="+e.download.fileLoc+"+name="+e.download.FileNme+"+domain="+a.host+"+cabinet="+o.PGID+"+f1="+n[0]+"+f2="+n[1]+"+f3="+n[2]+"+f4="+n[3]+"+f5="+n[4]+"+f6="+n[5]+"+f7="+n[6]+"+popFlag="+i.softpopFlag+"+zms="+t}},i.checkout=function(){i.spinner=!1;var e=$("#gridContainer").dxDataGrid("instance").getSelectedRowsData();1<e.length?e.reduce(function(e,o,r){return e.then(function(){return n=o,t=r,new Promise(function(e,o){setTimeout(function(){l(n,!1,t),e({value:n})},1500)});var n,t})},Promise.resolve()).then(function(){setTimeout(function(){$("#gridContainer").dxDataGrid("instance").clearSelection(),s.$$childTail.$$childHead.selectedRow=0,s.$$childTail.$$childHead.$apply()},2e3)}):l(e[0],!1)},i.wdCheckIn=function(e){var o=$("#checkin").dxFileUploader("instance");o._isCustomClickEvent=!0,o._$fileInput.click(),s.checkinType=e},i.checkin={uploadUrl:a.host+a.uploadLocation,bindingOptions:{multiple:"multiple",accept:"accept",value:"value",uploadMode:"uploadMode"},visible:!1,onUploadError:function(e){DevExpress.ui.notify("Upload failed! "+e.request.statusText,"error",4e3)},onUploaded:function(e){if("N"==s.checkinType)return i.uploadToWldox("1",e.file.name),!1;i.uploadToWldox("",e.file.name)}},i.uploadToWldox=function(n,t){var r={RN:i.rec,LID:i.list,LN:i.ln};c.uploadToWorldox(n,r,t).then(function(e){var o=e.data.uploadVerb;if(""!=o.errorStatus.ErrorCount)return DevExpress.ui.notify(o.errorStatus.wd_Error_MSG,"error",4e3),!1;i.checkToWdx(r,t,n)},function(e){DevExpress.ui.notify("IIS Error","error",4e3)})},i.checkToWdx=function(e,o,n){c.chkToWorldox(e,o).then(function(e){var o=e.data.fileStatus;if(""!=o.errorStatus.ErrorCount)return DevExpress.ui.notify(o.errorStatus.wd_Error_MSG,"error",4e3),!1;s.rec=i.rec,s.wdStatus=Math.round(new Date/1e3),s.checkType=n,DevExpress.ui.notify("DocID: "+i.doc+" checked in 'SUCCESSFULLY'!","success",4e3)},function(e){DevExpress.ui.notify("IIS Error","error",4e3)})},i.wdRevert=function(){var e=$("#gridContainer").dxDataGrid("instance").getSelectedRowsData();1<e.length?u.checkinSeveralRecords(e):u.checkinSingleRecord(e[0])}}}}]);